<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
</head>
<body>
    <h1>{{ game_name }}</h1>

    <script>
        var gameId = "{{ game_id }}";
    </script>
    <label for="biomeSelect">Biome:</label>
    <select id="biomeSelect" onchange="changeBiome(gameId)">
        {% for biome in biomes %}
            <option value="{{ biome.id }}" {% if biome.id == current_biome_id %}selected{% endif %}>{{ biome.name }}</option>
        {% endfor %}
    </select>
    
    <script>
    function changeBiome(gameId) {
        var select = document.getElementById("biomeSelect");
        var biomeId = select.options[select.selectedIndex].value;
        fetch("/change_biome/" + gameId, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({biome_id: biomeId}),
        })
        // Update the biome encounters table
        .then(response => response.json())
        .then(table_entries => {
            var table = document.getElementById("biomeEncountersTable");
            // Clear the viewport table
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            // Add rows back with updated entries to the table
            for (var i = 0; i < table_entries.length; i++) {
                var row = table.insertRow(-1);
                for (var j = 1; j < table_entries[i].length; j++) {
                    var cell = row.insertCell(j - 1);
                    cell.innerHTML = table_entries[i][j];
                }
            }
        });
    }
    </script>
    <br><hr>

    <h2>Main Encounter Probability Table</h2>
    <form action="{{ url_for('roll_type', game_id=game_id) }}" method="post">
        <table>
            <thead>
                <tr>
                    <th><input type="submit" value="Roll"></th>
                    <th>Encounter Type</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody>
                {% for id, roll_range, encounter_type in encounter_types %}
                    <tr data-id="{{ id }}">
                        <td>{{ roll_range }}</td>
                        <td>{{ encounter_type}}</td>
                        <td><button class="range-button">Range</button></td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="2">No encounter types set.</td>
                    </tr>
                {% endfor %}
        </table>
    </form>
    <br><hr>

    <h2>Encounters</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <br>

    <button id="toggleButtonGeneral">General Encounters</button>
    <div id="generalEncounters" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for id, roll_range, description in encounters_general %}
                    <tr>
                        <td>{{ roll_range }}</td>
                        <td>{{ description }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="2">No general encounters set.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <br>

    <button id="toggleButtonBiome">Biome Encounters</button>
    <div id="biomeEncounters" style="display: none;">
        <table id="biomeEncountersTable">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for id, roll_range, description in encounters_biome %}
                    <tr>
                        <td>{{ roll_range }}</td>
                        <td>{{ description }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="2">No biome encounters set.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // Toggle visibility of encounter tables
        function toggleVisibility(buttonId, divId, sessionKey) {
            var button = document.getElementById(buttonId);
            var div = document.getElementById(divId);
            button.onclick = function() {
                if (div.style.display === "none") {
                    div.style.display = "block";
                    this.textContent = "Hide " + this.textContent;
                    sessionStorage.setItem(sessionKey, 'true');
                } else {
                    div.style.display = "none";
                    this.textContent = this.textContent.replace("Hide ", "");
                    sessionStorage.setItem(sessionKey, "false");
                }
            }
        }

        toggleVisibility("toggleButtonGeneral", "generalEncounters", 'generalEncountersVisible');
        toggleVisibility("toggleButtonBiome", "biomeEncounters", 'biomeEncountersVisible');
    </script>

    <script>
        // Restore visibility setting of encounter tables after page reload
        window.onload = function() {
            // get visibility state from session storage
            var generalEncountersVisible = sessionStorage.getItem("generalEncountersVisible");
            var biomeEncountersVisible = sessionStorage.getItem("biomeEncountersVisible");

            // get references to the div elements
            var generalEncounters = document.getElementById("generalEncounters");
            var biomeEncounters = document.getElementById("biomeEncounters");

            // get references to the button elements
            var toggleButtonGeneral = document.getElementById("toggleButtonGeneral");
            var toggleButtonBiome = document.getElementById("toggleButtonBiome");

            if (generalEncountersVisible === "true") {
                generalEncounters.style.display = "block";
                toggleButtonGeneral.textContent = "Hide General Encounters";
            }

            if (biomeEncountersVisible === "true") {
                biomeEncounters.style.display = "block";
                toggleButtonBiome.textContent = "Hide Biome Encounters";
            }
        }
    </script>

    <script>
        // Event listener to edit range buttons
        document.querySelectorAll(".range-button").forEach(function(button) {
            button.addEventListener("click", function() {
                var td = this.parentNode;

                var tr = td.parentNode;

                td.innerHTML = '';
                var input = document.createElement("input");
                input.type = "text";
                input.placeholder = "New value, e.g. 20";
                td.appendChild(input);
                input.focus();

                // Event listener to input range field
                input.addEventListener("keydown", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();

                        console.log("ID:", tr.id);
                        var newValue = event.target.value.trim();
                        var id = tr.getAttribute("data-id");

                        // Send request to server
                        fetch("/change_roll_range/" + gameId, {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({id: id, roll_range: newValue}),
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Server responded with status: ${response.status}");
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Success:", data);
                            location.reload();
                        })
                        .catch(error => {
                            console.error("Fetch error:", error);
                        });
                    }
                });
            });
        });
    </script>
    <br><hr>

    <a href="/dashboard">Back to dashboard</a>
    <a href="/logout">Logout</a>

</body>
</html>